{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-5">
        <div class="glass-panel mt-5">
            <h2 class="text-center mb-4">Login</h2>
            <form id="loginForm">
                <div class="mb-3">
                    <label class="form-label">Username</label>
                    <input type="text" name="username" class="form-control" autocomplete="username" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Password</label>
                    <input type="password" name="password" class="form-control" autocomplete="current-password"
                        required>
                </div>
                <button type="submit" class="btn btn-palette-primary w-100">Login</button>
            </form>
            <div class="mt-3 text-center d-flex flex-column gap-2">
                <a href="{{ url_for('auth.register') }}" class="text-palette-secondary">Create an account</a>
                <a href="#"
                    onclick="alert('Please contact Admin to reset password (Email feature skipped for prototype speed unless requested)')"
                    class="small text-muted">Forgot Password?</a>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<script>
    const loginForm = document.getElementById('loginForm');
    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault(); // STOP native submission
        e.stopImmediatePropagation();

        const btn = loginForm.querySelector('button[type="submit"]');
        if (btn.disabled) return; // Prevent double clicks

        btn.disabled = true;
        btn.innerText = "Processing...";

        const formData = new FormData(loginForm);
        const data = Object.fromEntries(formData.entries());

        try {
            const res = await postJSON("{{ url_for('auth.login') }}", data);
            if (res.redirect) {
                window.location.href = res.redirect;
            } else {
                alert(res.message || 'Login failed');
                btn.disabled = false;
                btn.innerText = "Login";
            }
        } catch (error) {
            console.error("Login Error:", error);
            alert("An error occurred.");
            btn.disabled = false;
            btn.innerText = "Login";
        }
    });
</script>
{% endblock %}
{% endblock %}